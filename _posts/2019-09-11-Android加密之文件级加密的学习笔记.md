---
title: Android加密之文件级加密的学习笔记
date: 2019-09-11 11:05
categories: 
- 源码解析
tags:
- android进阶
description: Android加密之文件级加密的学习笔记
---

#  Android加密之文件级加密

参考文章：[https://www.jianshu.com/p/d25f73805729](https://www.jianshu.com/p/d25f73805729)

​				[https://blog.csdn.net/myfriend0/article/details/76615114](https://blog.csdn.net/myfriend0/article/details/76615114)

## 什么是文件级加密

Android 7.0 及更高版本支持文件级加密 (FBE)。采用文件级加密时，可以使用不同的密钥对不同的文件进行加密，并且可以对这些文件进行单独解密。

## 什么是全盘加密

全盘加密是使用已加密的密钥对 Android 设备上的所有用户数据进行编码的过程。设备经过加密后，所有由用户创建的数据在写入磁盘之前都会自动加密，并且所有读取操作都会在将数据返回给调用进程之前自动解密数据。

Android 5.0 中又引入了以下新功能：

创建了快速加密方式，这种加密方式只会对数据分区中已使用的分块进行加密，以免首次启动用时过长。目前只有 EXT4 和 F2FS 文件系统支持快速加密。
添加了 forceencrypt fstab 标记，以便在首次启动时进行加密。
添加了对解锁图案和无密码加密的支持。
添加了由硬件支持的加密密钥存储空间，该空间使用可信执行环境（TEE，例如 TrustZone）的签名功能。

## 全盘加密和文件级加密的区别

借助文件级加密，Android 7.0 中引入了一项称为直接启动的新功能。该功能处于启用状态时，已加密设备在启动后将直接进入锁定屏幕。之前，在使用全盘加密 (FDE) 的已加密设备上，用户在访问任何数据之前都需要先提供凭据，从而导致手机无法执行除最基本操作之外的所有其他操作。例如，闹钟无法运行，无障碍服务不可用，手机无法接电话，而只能进行基本的紧急拨号操作。

## 文件级加密概述

引入文件级加密 (FBE) 和新 API 后，便可以将应用设为加密感知型应用，这样一来，它们将能够在受限环境中运行。这些应用将可以在用户提供凭据之前运行，同时系统仍能保护私密用户信息。

在启用了 FBE 的设备上，每位用户均有两个可供应用使用的存储位置：

- 凭据加密 (CE) 存储空间：这是默认存储位置，只有在用户解锁设备后才可用。
- 设备加密 (DE) 存储空间：在直接启动模式期间以及用户解锁设备后均可用。

这种区分能够使工作资料更加安全，因为这样一来，加密不再只基于启动时密码，从而能够同时保护多位用户。

Direct Boot API 允许加密感知型应用访问上述每个区域。应用生命周期会发生一些变化，以便在用户的 CE 存储空间因用户在锁定屏幕上首次输入凭据而解锁时，或者在工作资料提供工作挑战时，通知应用。无论是否实现了 FBE，运行 Android 7.0 的设备都必须要支持这些新的 API 和生命周期。不过，如果没有 FBE，DE 和 CE 存储空间将始终处于解锁状态。

## 启用文件级加密

通过将不带参数的 fileencryption 标记添加到 userdata 分区最后一列的 fstab 行中，可以启用 FBE。

## 直接启动感知型应用

为了实现系统应用的快速迁移，新增了两个可在应用级别设置的属性。defaultToDeviceProtectedStorage 属性仅适用于系统应用，directBootAware 属性则适用于所有应用。

```xml
<application
		android:directBootAware="true"
		android:defaultToDeviceProtectedStorage="true">
```

应用级别的 directBootAware 属性的含义是将相应应用中的所有组件均标记为加密感知型组件。

defaultToDeviceProtectedStorage 属性用于将默认的应用存储位置重定向到 DE 存储空间（而非 CE 存储空间）。使用此标记的系统应用必须要仔细审核存储在默认位置的所有数据，并将敏感数据的路径更改为使用 CE 存储空间。使用此选项的设备制造商应仔细检查要存储的数据，以确保其中不含任何个人信息。

在这种模式下运行时，以下系统 API 可在需要时用于明确管理由 CE 存储空间支持的 Context（这些 API 与设备保护存储空间适用的同类 API 相对应）。

- StorageManager.isFileEncryptedNativeOrEmulated()
- Context.createCredentialProtectedStorageContext()
- Context.isCredentialProtectedStorage()

DE 存储空间支持的 Context

- Context.createDeviceProtectedStorageContext()
- Context.isDeviceProtectedStorage()



## 总结

文件级加密，比较全盘加密具有一些优点，可以让没有输入凭证的设备可以使用更多的功能。文件级加密分 CE 空间和 DE 空间，CE 空间需要凭证加密方可使用，DE 空间则是设备启动后即可使用。应用如果需要区分 CE 和 DE 空间，需要创建不同的上下文环境 Context。

